# vim: set ft=sh sw=2 ts=8 et :
deploy_stagemanager_variants="default t1_uk_ral t1_us_fnal t1_tw_asgc t1_it_cnaf t1_de_kit t1_fr_ccin2p3 t1_es_pic"

deploy_stagemanager_deps()
{
  case $variant in default ) deploy couchdb ;; * ) deploy couchdb offsite ;; esac
}

deploy_stagemanager_prep()
{
  # offsite deployments run the Agent daemon, so state/logs are needed there
  case $variant in default ) mkproj -s -l ;; * ) mkproj ;; esac
}

deploy_stagemanager_sw()
{
  deploy_pkg comp cms+stagemanager 0.0.1-comp2
  case $variant in
    t1_* ) deploy_pkg comp cms+stagemanager-agent 0.0.2 ;;
  esac
}

deploy_stagemanager_post()
{
  # Tell couchdb to pick up stage manager on the next restart
  # and configure replication, compaction and backup, too
  local couchdb_config=$root/current/config/couchdb
  local couchdb_state=$root/state/couchdb

  for area in compaction stagingarea replication backup; do
    rm -f $couchdb_state/$area/stagemanager
    touch $couchdb_state/$area/stagemanager
  done

  local dbs=""
  case $variant in
    default ) 
      for site in ${deploy_stagemanager_variants#default }; do
        dbs=$(echo $dbs ${site}_{requests,statistics})
      done
      ;;
    * ) dbs=$(echo ${variant}_{requests,statistics,stagequeue,configuration});;
  esac

  local couch_crons=""
  local hour=0
  for db in $dbs; do
    # Push the database
    echo "couchapp push $root/current/apps/stagemanager/${db##*_} http://localhost:5984/$db" >> $couchdb_state/stagingarea/stagemanager

    # Setup database compaction
    local cmd="$couchdb_config/manage compact $db 'I did read documentation'"
    $nogroups || cmd="sudo -H -u _couchdb bashs -l -c \"${cmd}\""
    couch_crons="${couch_crons}12 $hour * * * $cmd\n"
    hour=$(( $hour + 1 ))
  done

  case $variant in
    default ) ;;
    * ) 
      # Setup database replication
      (echo {,https://cmsweb.cern.ch/couchdb/}${variant}_statistics # unidirectional
       echo {,https://cmsweb.cern.ch/couchdb/}${variant}_requests
       echo {https://cmsweb.cern.ch/couchdb/,}${variant}_requests
      ) > $couchdb_state/replication/stagemanager
      ;;
  esac

  (mkcrontab
   case $host in
     vocms10[67] | vocms50 | vocms13[2689] ) ;;
     * ) echo -ne "${couch_crons}" ;;
   esac
  ) | crontab -
}
