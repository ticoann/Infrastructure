# vim: set ft=sh sw=2 ts=8 et :
deploy_phedex_datasvc_deps()
{
  deploy Backend
}

deploy_phedex_datasvc_prep()
{
  mkproj phedex-webapp logs cache/phedex-datasvc
  setgroup ug+rw,o-w _phedex $PWD/{logs,cache/phedex-datasvc}
}

deploy_phedex_datasvc_sw()
{
  deploy_pkg -d phedex-webapp -l srv comp cms+PHEDEX-datasvc DATASVC_1_6_3-cmp3
  chmod a+x srv/bin/trim-cache
  perl -p -i -e "s{/where/i/put/my}{$root/projects/conf/phedex}g" \
    srv/PhEDExWeb/DataService/conf/datasvc-app.conf

  rm -f apache2
  ln -s $root/$(echo comp | sed -e "$repoedit")sw/apache2 apache2
  setgroup g+w _config apache2/{logs,var} # hack, need to write here too
  setgroup g+w _config apache2/logs/start_stop.log

  # Fix up feedback-mail
  cd srv/PhEDExWeb/DataService/conf
  rm -f datasvc-app.conf.new
  (grep -v "^feedback-mail:" < datasvc-app.conf
   echo; echo "feedback-mail: cms-phedex-admins@cern.ch") > datasvc-app.conf.new
  mv datasvc-app.conf{.new,}
}

deploy_phedex_datasvc_post()
{
  cd $root/projects/phedex-webapp
  cmd="$PWD/srv/bin/trim-cache 1000M"
  $nogroups || cmd="sudo -H -u _phedex bashs -c '$cmd'"
  (crontab -l | { fgrep -v "$PWD/" || true; }
   echo "0 * * * * $cmd") |
   crontab -
}
